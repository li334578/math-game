# Math Game

一个基于 React + Vite 的十以内加减法记忆/答题小游戏。

特性
- 出题节奏：每 3 秒出 1 题，共 30 题（TOTAL_QUESTIONS=30，QUESTION_DELAY=3000）
- 答题规则：
  - 第 6 题开始可回答第 1 题，此后每出新题推进可答题号（最多同时领先 5 题）
  - 第 30 题题面显示一次；当可答题达到第 26 题起，隐藏第 30 题题面（仅保留进度条与进度信息）
  - 第 30 题仍有一整段橙色倒计时；若期间未作答，倒计时结束后游戏自动结束
- 防止双推进：在 React 严格模式（开发环境）下，计时器/推进做了防重入保护，避免每次跳两题
- 排行榜：使用浏览器 localStorage 持久化，分数降序、用时升序，最多 100 条
- 结束页：支持提交成绩到排行榜；支持重新开始、回到首页、查看排行榜三项操作
- 题目生成：尽量避免连续两题题面或答案相同（最多重试 20 次）

运行
1) 安装依赖
   npm i
2) 开发启动
   npm run dev
3) 生产构建
   npm run build
4) 预览
   npm run preview

项目结构
- src/components/MathGame.tsx
  - 游戏主组件（出题/倒计时/答题/结果页/排行榜交互）
- src/types/game.ts
  - 题目/答案/游戏状态/结果类型定义

关键逻辑说明
- 双计数器
  - questionCounter：出题计数，1..30
  - answerCounter：答题计数，1..30
- 倒计时（橙色进度条）
  - 使用 setInterval 每 100ms 更新 UI 倒计时
  - 每次周期结束（时间用尽）触发推进逻辑
  - 严格模式防抖：100ms 内重复 tick 会被忽略，避免双推进
- 第 30 题自动结束
  - 推进到可答第 30 题后，进入“等待最终结束”阶段
  - 保留完整一段橙色倒计时；下一次周期触发时自动结束（若未作答）
- 隐藏第 30 题题面
  - 当 questionCounter===30 且 canAnswerQuestionId≥26 时，隐藏题面，只显示进度与条形图
- 排行榜
  - localStorage 键：mathGame_leaderboard_v1
  - 提交后本地排序并裁剪（最多 100 条）
  - 首页与结束页均可查看/切换展开

代码风格与约定
- 使用函数式更新 setState，避免对过期状态读写
- 计时器引用使用 ref 保存，并在卸载/结束时清理
- 变更点尽量小，保持组件内聚，后续可逐步模块化

可选的后续优化建议
- 模块化拆分
  - 拆分为子组件：HeaderStats（头部进度/分数）、QuestionView（题面+倒计时）、AnswerPanel（答题表单）、ResultView（结果+操作区）、LeaderboardPanel（榜单视图）
  - 抽离 hooks：useCountdown、useGameEngine、useLeaderboardStorage
  - 抽常量到 src/constants.ts，存储封装到 src/utils/storage.ts
- 更严格的题目生成
  - 保证相邻题目不重复答案/运算式，并加入题型平衡（加减占比/出题难度控制）
- 无障碍与键盘操作
  - 输入框自动聚焦已实现，可增加键盘快捷键、ARIA 提示
- 单元测试
  - 针对题目生成、推进规则、排行榜存取做基础测试（Vitest）
- 国际化
  - 提取文案，便于多语言支持
- PWA
  - 开启离线缓存，移动端体验更佳
- 后端可选升级
  - 若需要跨设备共享排行榜，可无缝接入简单后端服务（目前默认本地存储）

维护说明
- 若遇到“每次跳两题”：检查是否在严格模式下重复创建计时器；本项目已添加防重入，若自定义变更请保持该保护逻辑
- 修改第 30 题行为
  - 自动结束时机：由橙色条下一周期触发（可通过 QUESTION_DELAY 调整体验）
  - 隐藏题面阈值：当前为 canAnswerQuestionId≥26，可在 MathGame.tsx 中微调

许可证
- MIT